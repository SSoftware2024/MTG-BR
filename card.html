<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>MTG BR - CARTA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta charset="utf-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="favicon.ico" />
  <style>
    .card-text {
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .card-container {
      margin-bottom: 2rem;
      background-color: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .card-img {
      max-width: 100%;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
    }

    .separator {
      border-top: 2px dashed #1e40af;
      margin: 2rem 0;
    }

    .back-btn {
      display: inline-block;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: #1e40af;
      color: #fff;
      font-weight: bold;
      border-radius: 0.25rem;
      cursor: pointer;
    }

    .back-btn:hover {
      background-color: #2563eb;
    }

    #loader {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      display: none;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <div id="loader">
    <img src="loading-wtf.gif" alt="Carregando..." width="200" />
  </div>

  <div class="max-w-3xl mx-auto">
    <button id="back-btn" class="back-btn">← Voltar</button>

    <div id="card-container" class="card-container"></div>
  </div>

  <script>
    let mtgKeywords = {};

    // Carregar arquivo de keywords
    async function loadKeywords() {
      try {
        const res = await fetch('mtg_keywords.json');
        mtgKeywords = await res.json();
      } catch (e) {
        console.error('Erro ao carregar keywords', e);
      }
    }

    function showLoader() {
      document.getElementById('loader').style.display = 'block';
    }

    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    // Função que substitui keywords no texto
    function translateKeywords(text) {
      if (!text) return '';
      let translated = text;
      for (const key in mtgKeywords) {
        // Escapa caracteres especiais para regex
        const escapedKey = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedKey, 'gi');
        translated = translated.replace(regex, mtgKeywords[key]);
      }
      return translated;
    }

    // Função de tradução via API (para o resto do texto)
    async function translateText(text) {
      if (!text) return '';
      // Primeiro substitui keywords
      const keywordTranslated = translateKeywords(text);
      // Se o texto não mudou, não precisa da API
      if (keywordTranslated !== text) return keywordTranslated;
      try {
        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|pt`;
        const res = await fetch(url);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch (e) {
        console.error('Erro na tradução', e);
        return text;
      }
    }

    async function getCard() {
      showLoader();
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      try {
        const res = await fetch(`https://api.scryfall.com/cards/${id}`);
        const card = await res.json();
        const container = document.getElementById('card-container');
        container.innerHTML = '';

        async function renderFace(face, faceIndex = 1) {
          const faceDiv = document.createElement('div');
          const nameOriginal = face.name || card.name || 'Sem nome';
          const oracleText = face.oracle_text || card.oracle_text || 'Sem texto';

          const nameTranslated = translateKeywords(nameOriginal);
          const textTranslated = await translateText(oracleText);

          faceDiv.innerHTML = `
            <h1 class="text-2xl font-bold mb-2">${nameOriginal}</h1>
            <h2 class="text-xl font-semibold mb-4 text-gray-700">${nameTranslated}</h2>
            <img src="${face.image_uris?.normal || card.image_uris?.normal || ''}" class="card-img" />
            <div class="mb-4">
              <h3 class="font-semibold">Texto Original:</h3>
              <p class="card-text bg-gray-100 p-3 rounded mb-2">${oracleText}</p>
            </div>
            <div>
              <h3 class="font-semibold">Texto em Português:</h3>
              <p class="card-text bg-gray-100 p-3 rounded">${textTranslated}</p>
            </div>
          `;

          if (faceIndex > 1) {
            const hr = document.createElement('hr');
            hr.className = 'separator';
            container.appendChild(hr);
          }

          container.appendChild(faceDiv);
        }

        if (card.card_faces && card.card_faces.length > 1) {
          for (let i = 0; i < card.card_faces.length; i++) {
            await renderFace(card.card_faces[i], i + 1);
          }
        } else {
          await renderFace(card);
        }

      } catch (e) {
        console.error('Erro ao carregar carta', e);
        document.getElementById('card-container').textContent = 'Erro ao carregar a carta.';
      } finally {
        hideLoader();
      }
    }

    document.getElementById('back-btn').onclick = () => {
      if (document.referrer.includes('index.html')) {
        window.history.back();
      } else {
        const params = new URLSearchParams(window.location.search);
        const q = params.get('q') || '';
        const page = params.get('page') || 1;
        window.location.href = `index.html?q=${encodeURIComponent(q)}&page=${page}`;
      }
    }

    // Carregar keywords e depois pegar a carta
    loadKeywords().then(getCard);
  </script>

</body>

</html>
